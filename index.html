<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель Тест-Хелпера</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Настройка шрифта Inter и базовые стили */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .chat-scroll {
            height: calc(100vh - 150px);
            overflow-y: auto;
        }
        .test-list-scroll {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-6 bg-gray-100 min-h-screen">

    <div id="app" class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto">
        
        <!-- Колонка с комнатами/статусом (Sidebar) -->
        <div class="lg:w-1/3 w-full bg-white p-4 rounded-xl shadow-lg h-full">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">
                Активные комнаты (Тесты)
            </h2>
            
            <!-- Статус WebSocket -->
            <div id="ws-status" class="mb-4 p-2 text-sm rounded-lg font-medium transition duration-300">
                Подключение...
            </div>

            <!-- Список комнат -->
            <div id="room-list" class="space-y-3 test-list-scroll">
                <p class="text-gray-500 text-sm">Ожидание данных с сервера...</p>
            </div>
        </div>

        <!-- Колонка с текущим тестом (Main Content) -->
        <div class="lg:w-2/3 w-full bg-white p-6 rounded-xl shadow-lg">
            <div id="test-view">
                <h2 id="current-test-title" class="text-2xl font-extrabold mb-2 text-indigo-700">
                    Выберите комнату для начала работы
                </h2>
                <p id="current-test-url" class="text-sm text-gray-500 mb-6 truncate">
                    URL: (Не выбрано)
                </p>

                <!-- Контейнер вопросов -->
                <div id="questions-container" class="space-y-8 chat-scroll p-2">
                    <div class="flex items-center justify-center h-full text-gray-400 text-lg py-20">
                        Тест будет загружен здесь после выбора комнаты.
                    </div>
                </div>

                <!-- Кнопка сохранения/отправки (внизу) -->
                <div class="mt-6 pt-4 border-t sticky bottom-0 bg-white">
                    <button id="submit-answers-btn" disabled class="w-full bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Отправить ответы клиенту
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные и настройки
        const production = location.protocol === 'https:' ?
            'wss://v1-ai.onrender.com' :
            'ws://localhost:10000';
        
        let socket = null;
        let adminId = `admin-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
        let isConnected = false;

        // Состояние приложения
        let state = {
            activeRooms: {}, // { roomNumber: { helperId, title, url, questions, answers } }
            selectedRoom: null, // Номер текущей комнаты
            currentAnswers: new Map(), // Map<questionId, answerText> для текущего теста
        };

        // DOM элементы
        const elements = {
            status: document.getElementById('ws-status'),
            roomList: document.getElementById('room-list'),
            title: document.getElementById('current-test-title'),
            url: document.getElementById('current-test-url'),
            questionsContainer: document.getElementById('questions-container'),
            submitBtn: document.getElementById('submit-answers-btn')
        };

        // --- WebSocket Логика ---

        function updateWsStatus(status, color, message) {
            elements.status.textContent = `${status}: ${message}`;
            elements.status.className = `mb-4 p-2 text-sm rounded-lg font-medium transition duration-300 ${color}`;
        }

        function connectWebSocket() {
            if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) return;
            
            updateWsStatus('Подключение', 'bg-yellow-100 text-yellow-800', 'Установка соединения...');
            socket = new WebSocket(production);

            socket.onopen = () => {
                isConnected = true;
                updateWsStatus('Подключено', 'bg-green-100 text-green-800', 'Ожидание новых тестов...');
                console.log(`[Admin] WebSocket connected. ID: ${adminId}`);
                
                // 1. Сообщаем серверу, что мы - админ
                socket.send(JSON.stringify({
                    type: "admin_connect",
                    adminId: adminId
                }));
                
                // 2. Запрашиваем текущее состояние всех комнат
                socket.send(JSON.stringify({ type: "request_room_status" }));
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleIncomingMessage(data);
                } catch (err) {
                    console.error('[Admin] Message parsing error:', err);
                }
            };

            socket.onerror = (error) => {
                isConnected = false;
                updateWsStatus('Ошибка', 'bg-red-100 text-red-800', 'Ошибка соединения.');
                console.error('[Admin] WebSocket error:', error);
            };

            socket.onclose = () => {
                isConnected = false;
                updateWsStatus('Отключено', 'bg-red-100 text-red-800', 'Переподключение через 5с...');
                console.log('[Admin] WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Обработка входящих сообщений
        function handleIncomingMessage(data) {
            console.log('[Admin] Received:', data.type, data);

            switch (data.type) {
                case 'room_status':
                    // Обновление списка активных комнат
                    state.activeRooms = data.rooms;
                    renderRoomList();
                    break;
                case 'new_test':
                    // Получен новый тест для комнаты
                    const roomNum = data.room;
                    state.activeRooms[roomNum] = {
                        room: roomNum,
                        helperId: data.helperId,
                        title: data.title,
                        url: data.url,
                        questions: data.questions,
                        answers: data.answers || {}, // Актуальные ответы для этого теста
                        timestamp: data.timestamp
                    };
                    renderRoomList();
                    
                    // Если это активная комната, обновляем ее
                    if (state.selectedRoom === roomNum) {
                        selectRoom(roomNum); // Перерисовываем с новыми вопросами
                    }
                    break;
                case 'answer_update':
                    // Ответ обновился (например, другим админом).
                    const updatedRoom = state.activeRooms[data.room];
                    if (updatedRoom) {
                        updatedRoom.answers[data.questionId] = data.answer;
                        if (state.selectedRoom === data.room) {
                            state.currentAnswers.set(data.questionId, data.answer);
                            renderQuestions(updatedRoom.questions);
                        }
                    }
                    break;
                case 'room_disconnected':
                    // Клиент отключился
                    delete state.activeRooms[data.room];
                    renderRoomList();
                    if (state.selectedRoom === data.room) {
                        state.selectedRoom = null;
                        renderTestView();
                    }
                    break;
            }
        }

        // --- UI Логика: Список комнат ---

        function renderRoomList() {
            elements.roomList.innerHTML = '';
            const rooms = Object.values(state.activeRooms).sort((a, b) => b.timestamp - a.timestamp);

            if (rooms.length === 0) {
                elements.roomList.innerHTML = '<p class="text-gray-500 text-sm">Нет активных клиентов. Откройте клиентский скрипт, чтобы увидеть комнату.</p>';
                return;
            }

            rooms.forEach(roomData => {
                const isSelected = roomData.room === state.selectedRoom;
                const lastUpdate = new Date(roomData.timestamp).toLocaleTimeString('ru-RU');
                
                const roomElement = document.createElement('div');
                roomElement.className = `
                    p-3 border rounded-lg cursor-pointer transition duration-150
                    ${isSelected 
                        ? 'bg-indigo-500 text-white shadow-md border-indigo-500 transform scale-[1.02]' 
                        : 'bg-white hover:bg-gray-50 border-gray-200'
                    }
                `;
                roomElement.innerHTML = `
                    <p class="font-bold text-lg">Комната #${roomData.room}</p>
                    <p class="text-sm ${isSelected ? 'text-indigo-200' : 'text-gray-600'} truncate">${roomData.title || 'Тест без названия'}</p>
                    <p class="text-xs ${isSelected ? 'text-indigo-300' : 'text-gray-400'} mt-1">Последний тест: ${lastUpdate}</p>
                `;
                roomElement.onclick = () => selectRoom(roomData.room);
                elements.roomList.appendChild(roomElement);
            });
        }
        
        // Выбор комнаты
        function selectRoom(roomNumber) {
            state.selectedRoom = roomNumber;
            const roomData = state.activeRooms[roomNumber];
            
            if (roomData) {
                // Обновляем текущие ответы
                state.currentAnswers.clear();
                Object.entries(roomData.answers).forEach(([qId, answerText]) => {
                    state.currentAnswers.set(qId, answerText);
                });
                
                renderTestView(roomData);
            }
            renderRoomList(); // Обновляем подсветку
        }

        // --- UI Логика: Текущий тест ---

        function renderTestView(roomData = null) {
            if (!roomData && !state.selectedRoom) {
                elements.title.textContent = 'Выберите комнату для начала работы';
                elements.url.textContent = 'URL: (Не выбрано)';
                elements.questionsContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-400 text-lg py-20">
                        Тест будет загружен здесь после выбора комнаты.
                    </div>
                `;
                elements.submitBtn.disabled = true;
                return;
            }

            const currentRoom = roomData || state.activeRooms[state.selectedRoom];
            if (!currentRoom) return;

            elements.title.textContent = currentRoom.title || `Тест из Комнаты #${currentRoom.room}`;
            elements.url.textContent = `URL: ${currentRoom.url}`;
            elements.submitBtn.disabled = false;
            
            renderQuestions(currentRoom.questions);
        }

        // Рендеринг вопросов
        function renderQuestions(questions) {
            elements.questionsContainer.innerHTML = '';
            
            questions.forEach(q => {
                const currentAnswer = state.currentAnswers.get(q.id) || '';
                
                const questionElement = document.createElement('div');
                questionElement.className = 'p-5 border border-gray-200 rounded-lg shadow-sm bg-white hover:shadow-md transition duration-200';
                questionElement.setAttribute('data-question-id', q.id);
                questionElement.innerHTML = `
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">
                        ${q.number}. ${q.text}
                    </h4>
                    <p class="font-medium text-sm text-indigo-500 mb-2">
                        Ваш ответ: <span id="answer-display-${q.id}" class="font-bold">${currentAnswer || 'Ожидание ответа...'}</span>
                    </p>
                    <div class="space-y-2 mb-4">
                        ${q.options.map((opt, index) => {
                            const optText = opt.text.trim().replace(/"/g, '&quot;');
                            const isSelected = currentAnswer === optText;
                            
                            return `
                                <label class="flex items-start p-3 border rounded-lg cursor-pointer transition-all duration-150 ${isSelected ? 'bg-green-50 border-green-400 ring-2 ring-green-500' : 'bg-gray-50 hover:bg-gray-100'}">
                                    <input 
                                        type="radio" 
                                        name="q-${q.id}" 
                                        value="${optText}"
                                        class="mt-1 mr-3 w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                                        ${isSelected ? 'checked' : ''}
                                        onchange="handleAnswerChange('${q.id}', this.value)"
                                    >
                                    <span class="text-gray-800 text-sm font-medium leading-relaxed">${optText}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Альтернативный ввод (если не подходит мультивыбор) -->
                    <div class="mt-4">
                        <label for="input-${q.id}" class="block text-sm font-medium text-gray-700 mb-1">
                            Ввести ответ вручную:
                        </label>
                        <input 
                            type="text" 
                            id="input-${q.id}" 
                            value="${currentAnswer}" 
                            class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2"
                            onblur="handleManualAnswerChange('${q.id}', this.value)"
                        >
                    </div>
                `;
                elements.questionsContainer.appendChild(questionElement);
            });
        }
        
        // Обработчик выбора ответа (Radio)
        window.handleAnswerChange = function(questionId, answerText) {
            const oldAnswer = state.currentAnswers.get(questionId);
            if (oldAnswer !== answerText) {
                state.currentAnswers.set(questionId, answerText);
                document.getElementById(`answer-display-${questionId}`).textContent = answerText;
                // Обновляем и ручной ввод
                document.getElementById(`input-${questionId}`).value = answerText;
            }
        }
        
        // Обработчик ручного ввода
        window.handleManualAnswerChange = function(questionId, answerText) {
            const trimmedAnswer = answerText.trim();
            const oldAnswer = state.currentAnswers.get(questionId);
            
            if (oldAnswer !== trimmedAnswer) {
                state.currentAnswers.set(questionId, trimmedAnswer);
                document.getElementById(`answer-display-${questionId}`).textContent = trimmedAnswer || 'Ожидание ответа...';

                // Снимаем выбор с Radio
                const radioInputs = document.querySelectorAll(`input[name="q-${questionId}"]`);
                radioInputs.forEach(input => {
                    if (input.value === trimmedAnswer) {
                        input.checked = true;
                        input.closest('label').classList.add('bg-green-50', 'border-green-400', 'ring-2', 'ring-green-500');
                    } else {
                        input.checked = false;
                        input.closest('label').classList.remove('bg-green-50', 'border-green-400', 'ring-2', 'ring-green-500');
                    }
                });
            }
        }
        
        // Отправка всех ответов
        function submitAnswers() {
            if (!isConnected || !state.selectedRoom) {
                alert('Нет активного подключения или не выбрана комната.');
                return;
            }
            
            const answersPayload = {};
            state.currentAnswers.forEach((answer, questionId) => {
                if (answer && answer.trim() !== '') {
                    answersPayload[questionId] = { answer: answer.trim() };
                }
            });

            if (Object.keys(answersPayload).length === 0) {
                 alert('Пожалуйста, введите хотя бы один ответ.');
                 return;
            }
            
            // Сохраняем в локальное состояние (для отображения)
            const roomData = state.activeRooms[state.selectedRoom];
            if (roomData) {
                roomData.answers = {};
                Object.entries(answersPayload).forEach(([qId, data]) => {
                    roomData.answers[qId] = data.answer;
                });
            }

            // Отправляем на сервер
            socket.send(JSON.stringify({
                type: 'submit_answers',
                adminId: adminId,
                room: state.selectedRoom,
                answers: answersPayload
            }));

            // Визуальный фидбек
            elements.submitBtn.textContent = 'Ответы отправлены!';
            elements.submitBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            elements.submitBtn.classList.add('bg-green-500', 'hover:bg-green-600');

            setTimeout(() => {
                elements.submitBtn.textContent = 'Отправить ответы клиенту';
                elements.submitBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
                elements.submitBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            }, 1500);
        }

        // --- Инициализация ---

        window.onload = function() {
            connectWebSocket();
            elements.submitBtn.addEventListener('click', submitAnswers);
        };
    </script>
</body>
</html>

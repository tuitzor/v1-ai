<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка — АвтоТесты</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --accent: #00ff9d;
            --text: #e0e0e0;
            --text-muted: #888;
        }
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        header h1 {
            margin: 0;
            font-size: 2.2em;
            background: linear-gradient(90deg, #00ff9d, #00b8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat {
            background: var(--card);
            padding: 15px 25px;
            border-radius: 12px;
            text-align: center;
            min-width: 140px;
            box-shadow: 0 4px 15px rgba(0,255,157,0.1);
        }
        .stat strong { display: block; font-size: 2em; color: var(--accent); }

        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
        }
        .test-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .test-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0,255,157,0.2);
        }
        .test-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            padding: 16px;
            color: white;
        }
        .test-header h3 {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .test-info {
            padding: 12px 16px;
            font-size: 0.9em;
            color: var(--text-muted);
        }
        .questions-count {
            background: rgba(0,255,157,0.15);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 8px;
        }

        /* Модалка с тестом */
        #test-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
            align-items: flex-start;
            justify-content: center;
        }
        .modal-content {
            background: #111;
            border-radius: 20px;
            width: 100%;
            max-width: 1100px;
            margin: 40px auto;
            box-shadow: 0 20px 60px rgba(0,255,157,0.2);
            position: relative;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { margin: 0; color: var(--accent); }
        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: #aaa;
            cursor: pointer;
        }
        .questions-container {
            padding: 20px;
            display: grid;
            gap: 30px;
        }
        .question {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #333;
        }
        .question-num {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .question-img, .answer-img {
            max-width: 100%;
            border-radius: 12px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .answer {
            text-align: center;
            padding: 10px;
            background: #222;
            border-radius: 12px;
            border: 2px solid transparent;
        }
        .answer-letter {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: black;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.4em;
            color: #666;
        }
        .no-tests { text-align: center; padding: 80px; color: #888; font-size: 1.5em; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>АВТО-ТЕСТЫ ОНЛАЙН</h1>
        <p>Все тесты приходят автоматически · Никаких скринов</p>
    </header>

    <div class="stats">
        <div class="stat">
            <strong id="total-tests">0</strong>
            <div>Всего тестов</div>
        </div>
        <div class="stat">
            <strong id="total-questions">0</strong>
            <div>Вопросов</div>
        </div>
        <div class="stat">
            <strong id="last-update">-</strong>
            <div>Последний</div>
        </div>
    </div>

    <div id="tests-container" class="tests-grid">
        <div class="loading">Ожидание тестов...</div>
    </div>
</div>

<!-- Модалка -->
<div id="test-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Тест</h2>
            <button class="close-btn" id="close-modal">×</button>
        </div>
        <div class="questions-container" id="modal-questions"></div>
    </div>
</div>

<script>
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProtocol}//${location.host}`);

    const testsContainer = document.getElementById('tests-container');
    const totalTestsEl = document.getElementById('total-tests');
    const totalQuestionsEl = document.getElementById('total-questions');
    const lastUpdateEl = document.getElementById('last-update');
    const modal = document.getElementById('test-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalQuestions = document.getElementById('modal-questions');
    const closeModal = document.getElementById('close-modal');

    let allTests = new Map(); // helperId → testData

    ws.onopen = () => {
        console.log('Админка подключена');
        ws.send(JSON.stringify({ type: 'admin_connect', role: 'admin' }));
    };

    ws.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);

            if (data.type === 'all_tests_full') {
                allTests = new Map(Object.entries(data.tests));
                renderTests();
            }

            if (data.type === 'full_test_update' || data.type === 'new_test_received') {
                const test = data.test || data;
                if (test && test.helperId) {
                    allTests.set(test.helperId, test);
                    renderTests();
                    updateStats();
                }
            }
        } catch (err) {
            console.error('Ошибка парсинга:', err);
        }
    };

    function updateStats() {
        const total = allTests.size;
        const questions = Array.from(allTests.values()).reduce((sum, t) => sum + t.data.length, 0);
        const last = Array.from(allTests.values()).sort((a,b) => b.timestamp - a.timestamp)[0];
        totalTestsEl.textContent = total;
        totalQuestionsEl.textContent = questions;
        lastUpdateEl.textContent = last ? new Date(last.timestamp).toLocaleTimeString() : '-';
    }

    function renderTests() {
        testsContainer.innerHTML = '';

        if (allTests.size === 0) {
            testsContainer.innerHTML = '<div class="no-tests">Тесты ещё не пришли<br>Ждём студентов...</div>';
            return;
        }

        // Сортируем по времени (новые сверху)
        const sorted = Array.from(allTests.values()).sort((a,b) => b.timestamp - a.timestamp);

        sorted.forEach(test => {
            const card = document.createElement('div');
            card.className = 'test-card';
            card.onclick = () => openTestModal(test);

            const time = new Date(test.timestamp).toLocaleString();

            card.innerHTML = `
                <div class="test-header">
                    <h3>${test.helperId}</h3>
                </div>
                <div class="test-info">
                    <div>URL: ${test.url || 'неизвестно'}</div>
                    <div style="margin-top:8px; opacity:0.8;">${time}</div>
                    <div class="questions-count">${test.data.length} вопросов</div>
                </div>
            `;
            testsContainer.appendChild(card);
        });

        updateStats();
    }

    function openTestModal(test) {
        modalTitle.textContent = `${test.helperId} · ${test.data.length} вопросов`;
        modalQuestions.innerHTML = '';

        test.data.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'question';

            qDiv.innerHTML = `
                <div class="question-num">Вопрос ${idx + 1} ${q.points ? `· ${q.points} балл(а)` : ''}</div>
                ${q.questionImage ? `<img src="${q.questionImage}" class="question-img" loading="lazy">` : '<i>Вопрос без изображения</i>'}
                
                <div class="answers-grid">
                    ${q.answers.map(ans => `
                        <div class="answer">
                            <div class="answer-letter">${ans.letter}</div>
                            <img src="${ans.image}" class="answer-img" loading="lazy">
                        </div>
                    `).join('')}
                </div>
            `;
            modalQuestions.appendChild(qDiv);
        });

        modal.style.display = 'flex';
    }

    closeModal.onclick = () => modal.style.display = 'none';
    modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

    // Автообновление каждые 10 сек (на всякий)
    setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'admin_connect', role: 'admin' }));
        }
    }, 10000);
</script>
</body>
</html>

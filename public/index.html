<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ЖИВЫЕ ТЕСТЫ — АДМИН + ПОМОЩНИК</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root { --bg: #0d0d0d; --card: #1a1a1a; --green: #00ff88; --red: #ff3366; }
    body { margin:0; font-family: 'Segoe UI', sans-serif; background:var(--bg); color:#fff; }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    h1 { text-align:center; color:var(--green); text-shadow:0 0 20px var(--green); margin:20px 0; }
    .stats { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; margin:30px 0; }
    .stat { background:var(--card); padding:20px; border-radius:15px; text-align:center; min-width:130px; box-shadow:0 0 20px rgba(0,255,136,0.2); }
    .stat strong { font-size:2.5em; color:var(--green); display:block; }

    .rooms { display:grid; grid-template-columns:repeat(auto-fill, minmax(340px,1fr)); gap:20px; margin-top:30px; }
    .room { background:var(--card); border-radius:16px; padding:20px; cursor:pointer; transition:0.3s; border:2px solid #333; }
    .room:hover { border-color:var(--green); transform:scale(1.03); box-shadow:0 0 30px rgba(0,255,136,0.3); }
    .room h3 { margin:0 0 10px; color:var(--green); }
    .room small { opacity:0.8; }

    .test-view { display:none; background:var(--card); border-radius:20px; padding:30px; margin-top:30px; }
    .question { background:#111; border-radius:16px; padding:25px; margin-bottom:30px; border:2px solid #333; }
    .qnum { color:var(--green); font-size:1.5em; font-weight:bold; margin-bottom:15px; }
    .qimg { max-width:100%; border-radius:12px; margin:15px 0; box-shadow:0 0 20px rgba(0,0,0,0.8); }
    .answers { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:15px; margin-top:20px; }
    .ans { text-align:center; padding:15px; background:#0a0a0a; border-radius:12px; cursor:pointer; transition:0.3s; border:2px solid #444; }
    .ans:hover { border-color:var(--green); }
    .ans.correct { border-color:var(--green) !important; background:#002211 !important; box-shadow:0 0 20px rgba(0,255,136,0.5); animation:pulse 1.5s infinite; }
    .ans-letter { display:inline-block; width:40px; height:40px; background:var(--green); color:#000; border-radius:50%; font-weight:bold; font-size:1.4em; margin-bottom:10px; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    .back-btn { background:var(--green); color:#000; border:none; padding:12px 30px; border-radius:50px; font-size:1.1em; cursor:pointer; margin-bottom:20px; }
</style>
</head>
<body>

<div class="container">
    <h1>ЖИВЫЕ ТЕСТЫ — РЕАЛЬНОЕ ВРЕМЯ</h1>
    <div class="stats">
        <div class="stat"><strong id="total">0">0</strong><div>Комнат</div></div>
        <div class="stat"><strong id="questions">0</strong><div>Вопросов</div></div>
        <div class="stat"><strong id="answered">0</strong><div>Отвечено</div></div>
    </div>

    <div id="rooms-list" class="rooms"></div>

    <div id="test-view" class="test-view">
        <button class="back-btn" onclick="backToRooms()">Назад к комнатам</button>
        <h2 id="room-title">Комната</h2>
        <div id="questions"></div>
    </div>
</div>

<script>
    const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://') + location.host);
    const rooms = new Map(); // studentId → данные теста
    let currentRoom = null;

    ws.onopen = () => ws.send(JSON.stringify({ type: "admin_connect" }));

    ws.onmessage = (e) => {
        const d = JSON.parse(e.data);

        if (d.type === "room_list") {
            d.rooms.forEach(r => rooms.set(r.studentId, r));
            renderRooms();
        }
        if (d.type === "new_room" || d.type === "answer_update") {
            rooms.set(d.studentId, d);
            renderRooms();
            if (currentRoom === d.studentId) renderTest(d);
        }
    };

    function renderRooms() {
        const list = document.getElementById('rooms-list');
        const sorted = Array.from(rooms.values()).sort((a,b) => b.timestamp - a.timestamp);
        
        list.innerHTML = sorted.map(r => `
            <div class="room" onclick="openRoom('${r.studentId}')">
                <h3>Комната ${r.studentId.slice(-10)}</h3>
                <div>Вопросов: <b>${r.total}</b> | Отвечено: <b>${Object.keys(r.answers||{}).length}</b></div>
                <small>${new Date(r.timestamp).toLocaleTimeString()}</small>
            </div>
        `).join('') || '<div style="grid-column:1/-1;text-align:center;color:#666;padding:50px;font-size:1.5em;">Ожидаем студентов...</div>';

        document.getElementById('total').textContent = rooms.size;
        document.getElementById('questions').textContent = sorted.reduce((s,r)=>s+r.total,0);
        document.getElementById('answered').textContent = sorted.reduce((s,r)=>s+Object.keys(r.answers||{}).length,0);
    }

    function openRoom(id) {
        currentRoom = id;
        const room = rooms.get(id);
        document.getElementById('rooms-list').style.display = 'none';
        document.getElementById('test-view').style.display = 'block';
        document.getElementById('title').textContent = `Комната ${id.slice(-10)} — ${room.total} вопросов`;
        renderTest(room);
    }

    function renderTest(room) {
        const container = document.getElementById('questions');
        container.innerHTML = room.questions.map((q, i) => {
            const correct = room.answers?.[q.index];
            return `
                <div class="question">
                    <div class="qnum">Вопрос ${q.index}</div>
                    <img src="${q.questionImage}" class="qimg">
                    <div class="answers">
                        ${q.options.map(o => `
                            <div class="ans ${correct===o.letter?'correct':''}" onclick="setAnswer('${room.studentId}',${q.index},'${o.letter}')">
                                <div class="ans-letter">${o.letter.toUpperCase()}</div>
                                <img src="${o.image}" style="max-width:100%;border-radius:8px;">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function setAnswer(studentId, qIndex, letter) {
        ws.send(JSON.stringify({
            type: "set_answer",
            studentId,
            questionIndex: qIndex,
            letter
        }));
    }

    function backToRooms() {
        document.getElementById('test-view').style.display = 'none';
        document.getElementById('rooms-list').style.display = 'grid';
        currentRoom = null;
    }

    // Автообновление списка каждые 8 сек
    setInterval(() => ws.readyState===1 && ws.send(JSON.stringify({type:"request_rooms"})), 8000);
</script>
</body>
</html>
